name: Publish

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        loader: [ fabric, forge, neoforge ]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - name: Build ${{ matrix.loader }}
        run: |
          chmod +x gradlew
          ./gradlew :${{ matrix.loader }}:build

      - name: Upload jar artifact
        uses: actions/upload-artifact@v4
        with:
          name: jar-${{ matrix.loader }}
          if-no-files-found: error
          path: |
            ${{ matrix.loader }}/build/libs/*.jar

  publish:
    runs-on: ubuntu-latest
    needs: build
    environment: production
    strategy:
      fail-fast: false
      matrix:
        loader: [ fabric, forge, neoforge ]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: jar-${{ matrix.loader }}
          path: dist

      - name: Pick release jar
        shell: bash
        run: |
          set -euo pipefail
          JAR=$(ls -1 dist/*.jar | grep -Ev '(-sources|-javadoc|-dev)\.jar$' | head -n 1)
          echo "JAR=$JAR" >> $GITHUB_ENV
          echo "Using $JAR"

      - name: Publish to Modrinth (${{ matrix.loader }})
        uses: Kir-Antipov/mc-publish@v3
        with:
          modrinth-id: 4AtIxJG2
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

          curseforge-id: 1415270
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}

          #github-token: ${{ secrets.GITHUB_TOKEN }}
          #github-tag: v${{ needs.build.outputs.version }}
          #github-name: Release v${{ needs.build.outputs.version }}

          files: |
            ${{ env.JAR }}

          version: 1.0+${{ matrix.loader }}.build.${{ github.run_number }}
          name: test (${{ matrix.loader }}) 1.0+build.${{ github.run_number }}

          loaders: |
            ${{ matrix.loader }}

          game-versions: |
            1.21.11

          changelog: test