name: Publish

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        loader: [ fabric, forge, neoforge ]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - name: Build ${{ matrix.loader }}
        run: |
          chmod +x gradlew
          ./gradlew :${{ matrix.loader }}:build

      - name: Upload jar artifact
        uses: actions/upload-artifact@v4
        with:
          name: jar-${{ matrix.loader }}
          if-no-files-found: error
          path: |
            ${{ matrix.loader }}/build/libs/*.jar

  release:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: jar-*
          path: dist
          merge-multiple: true

      - name: Pick release jars
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p upload

          pick() {
            local loader="$1"
            local jar
            jar="$(find dist -maxdepth 1 -type f -name '*.jar' \
              | grep -Ev '(-sources|-javadoc|-dev)\.jar$' \
              | grep -i "${loader}" \
              | head -n 1 || true)"
            if [[ -z "${jar:-}" ]]; then
              echo "❌ No main jar found for ${loader} in dist/"
              echo "Found jars:"
              ls -lah dist || true
              exit 1
            fi
            cp "$jar" "upload/"
            echo "✅ ${loader}: $jar"
          }

          pick fabric
          pick forge
          pick neoforge

          echo "Files to upload:"
          ls -lah upload

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.0+build.${{ github.run_number }}
          name: Release v1.0+build.${{ github.run_number }}
          draft: true
          body: |
            Release for build ${{ github.run_number }}
            - Fabric / Forge / NeoForge jars attached
          files: |
            upload/*.jar

  publish:
    runs-on: ubuntu-latest
    needs: [ build, release ]
    environment: production
    strategy:
      fail-fast: false
      matrix:
        loader: [ fabric, forge, neoforge ]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: jar-${{ matrix.loader }}
          path: dist

      - name: Pick release jar
        shell: bash
        run: |
          set -euo pipefail
          JAR=$(ls -1 dist/*.jar | grep -Ev '(-sources|-javadoc|-dev)\.jar$' | head -n 1)
          echo "JAR=$JAR" >> $GITHUB_ENV
          echo "Using $JAR"

      - name: Publish (${{ matrix.loader }})
        uses: Kir-Antipov/mc-publish@v3
        with:
          modrinth-id: 4AtIxJG2
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

          curseforge-id: 1415270
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}

          files: |
            ${{ env.JAR }}

          version: 1.0+${{ matrix.loader }}.build.${{ github.run_number }}
          name: test (${{ matrix.loader }}) 1.0+build.${{ github.run_number }}

          loaders: |
            ${{ matrix.loader }}

          game-versions: |
            1.21.11

          changelog: test