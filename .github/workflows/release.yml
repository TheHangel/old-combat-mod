name: Release

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GRADLE_OPTS: "-Xmx16G"
      JAVA_TOOL_OPTIONS: "-Xmx16G"
    strategy:
      fail-fast: false
      matrix:
        loader: [ fabric, forge, neoforge ]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - name: Build ${{ matrix.loader }}
        run: |
          chmod +x gradlew
          ./gradlew :${{ matrix.loader }}:build

      - name: Upload jar artifact
        uses: actions/upload-artifact@v4
        with:
          name: jar-${{ matrix.loader }}
          if-no-files-found: error
          path: |
            ${{ matrix.loader }}/build/libs/*.jar

  release:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Read versions from gradle.properties
        shell: bash
        run: |
          set -euo pipefail

          prop() {
            local key="$1"
            grep -E "^\s*${key}\s*=" gradle.properties | head -n1 | cut -d= -f2- | sed 's/^\s*//; s/\s*$//'
          }

          MC_VERSION="$(prop minecraft_version)"
          MOD_VERSION="$(prop version)"

          if [[ -z "${MC_VERSION}" || -z "${MOD_VERSION}" ]]; then
            echo "❌ Impossible de lire minecraft_version ou version depuis gradle.properties"
            exit 1
          fi

          echo "MC_VERSION=${MC_VERSION}" >> "$GITHUB_ENV"
          echo "MOD_VERSION=${MOD_VERSION}" >> "$GITHUB_ENV"

          echo "✅ MC_VERSION=${MC_VERSION}"
          echo "✅ MOD_VERSION=${MOD_VERSION}"

      - uses: actions/download-artifact@v4
        with:
          pattern: jar-*
          path: dist
          merge-multiple: true

      - name: Pick release jars
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p upload

          pick() {
            local loader="$1"
            local jar
            jar="$(find dist -maxdepth 1 -type f -name '*.jar' \
              | grep -Ev '(-sources|-javadoc|-dev)\.jar$' \
              | grep -i "${loader}" \
              | head -n 1 || true)"
            if [[ -z "${jar:-}" ]]; then
              echo "❌ No main jar found for ${loader} in dist/"
              echo "Found jars:"
              ls -lah dist || true
              exit 1
            fi
            cp "$jar" "upload/"
            echo "✅ ${loader}: $jar"
          }

          pick fabric
          pick forge
          pick neoforge

          echo "Files to upload:"
          ls -lah upload

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.MOD_VERSION }}+build.${{ github.run_number }}
          name: Release v${{ env.MOD_VERSION }} (Minecraft ${{ env.MC_VERSION }})
          generate_release_notes: true
          files: |
            upload/*.jar

  publish:
    runs-on: ubuntu-latest
    needs: [ build, release ]
    environment: production
    strategy:
      fail-fast: false
      matrix:
        loader: [ fabric, forge, neoforge ]
    steps:
      - uses: actions/checkout@v4
      - name: Read versions from gradle.properties
        shell: bash
        run: |
          set -euo pipefail

          prop() {
            local key="$1"
            grep -E "^\s*${key}\s*=" gradle.properties | head -n1 | cut -d= -f2- | sed 's/^\s*//; s/\s*$//'
          }

          MC_VERSION="$(prop minecraft_version)"
          MOD_VERSION="$(prop version)"

          if [[ -z "${MC_VERSION}" || -z "${MOD_VERSION}" ]]; then
            echo "❌ Impossible de lire minecraft_version ou version depuis gradle.properties"
            exit 1
          fi

          echo "MC_VERSION=${MC_VERSION}" >> "$GITHUB_ENV"
          echo "MOD_VERSION=${MOD_VERSION}" >> "$GITHUB_ENV"

          echo "✅ MC_VERSION=${MC_VERSION}"
          echo "✅ MOD_VERSION=${MOD_VERSION}"

      - uses: actions/download-artifact@v4
        with:
          name: jar-${{ matrix.loader }}
          path: dist

      - name: Pick release jar
        shell: bash
        run: |
          set -euo pipefail
          JAR=$(ls -1 dist/*.jar | grep -Ev '(-sources|-javadoc|-dev)\.jar$' | head -n 1)
          echo "JAR=$JAR" >> $GITHUB_ENV
          echo "Using $JAR"

      - name: Publish (${{ matrix.loader }})
        uses: Kir-Antipov/mc-publish@v3
        with:
          modrinth-id: dZ1APLkO
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

          curseforge-id: 430735
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}

          files: |
            ${{ env.JAR }}

          version: ${{ env.MOD_VERSION }}+${{ matrix.loader }}.build.${{ github.run_number }}
          name: ${{ matrix.loader }} ${{ env.MOD_VERSION }} (Minecraft ${{ env.MC_VERSION }})

          loaders: |
            ${{ matrix.loader }}

          game-versions: |
            ${{ env.MC_VERSION }}